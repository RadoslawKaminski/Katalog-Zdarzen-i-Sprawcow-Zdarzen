<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Katalog Sprawców i Zdarzeń</title>
    
    <!-- PWA / Instalacja -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">

    <!-- Biblioteka Vue.js - serce reaktywności aplikacji -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <!-- Biblioteka Dexie.js - upraszcza pracę z lokalną bazą danych IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <style>
        /* --- Podstawowe Style i Zmienne Kolorów --- */
        :root {
            --primary-color: #0d6efd; --dark-bg: #111315; --light-bg: #212529;
            --text-color: #dee2e6; --border-color: #495057; --success-color: #198754; --danger-color: #dc3545;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: var(--dark-bg); color: var(--text-color);
        }
        /* Zapobiega "mignięciu" niest gestylowanej treści przed załadowaniem Vue */
        #app { opacity: 0; transition: opacity 0.5s; }
        #app.ready { opacity: 1; }
        
        /* --- Nagłówek i Nawigacja --- */
        header {
            background-color: var(--light-bg); padding: 10px 15px;
            border-bottom: 2px solid var(--primary-color); position: sticky; top: 0; z-index: 100;
            display: grid; width: 100%; grid-template-columns: 40px 1fr 40px; align-items: center;
        }
        header h1 { margin: 0; font-size: 1.2em; text-align: center; grid-column: 2; }
        .settings-btn { background: none; border: none; color: var(--text-color); font-size: 1.5em; cursor: pointer; grid-column: 3; justify-self: end; }
        nav { display: flex; justify-content: stretch; margin-top: 10px; gap: 10px; grid-column: 1 / -1; }
        nav button {
            background-color: #343a40; color: var(--text-color); border: 1px solid var(--border-color);
            padding: 12px; border-radius: 8px; cursor: pointer; font-size: 1em; flex: 1; font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        nav button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        main { padding: 15px; }

        /* --- Przyciski i Formularze --- */
        .btn {
            display: block; width: 100%; text-align: center; background-color: var(--primary-color);
            color: white; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: 500;
            border: none; font-size: 1em; cursor: pointer;
        }
        .btn-success { background-color: var(--success-color); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-dynamic-add { background-color: #343a40; border: 1px dashed var(--border-color); margin-top: 15px; }
        .btn-icon { background: none; border: none; color: var(--text-color); font-size: 1.2em; cursor: pointer; padding: 5px; }

        form { display: flex; flex-direction: column; gap: 15px; }
        .form-section { background-color: var(--light-bg); padding: 15px; border-radius: 8px; }
        .form-section h3 { margin: 0 0 15px 0; }
        form input, form select, form textarea {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
            background-color: #495057; color: var(--text-color); font-size: 1em;
        }
        .form-group { display: flex; flex-direction: column; gap: 15px; }
        .form-group-inline { display: flex; align-items: center; gap: 10px; }
        .form-group-inline label { flex-shrink: 0; }
        .form-group-inline input { flex-grow: 1; }

        .photo-preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .photo-preview-container img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; }
        .photo-edit-wrapper { position: relative; }
        .photo-delete-btn {
            position: absolute; top: -5px; right: -5px; background-color: var(--danger-color);
            color: white; border: 2px solid var(--dark-bg); border-radius: 50%;
            width: 24px; height: 24px; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; line-height: 1;
        }

        /* --- Widok Katalogu --- */
        .baza-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .baza-controls input { flex-grow: 1; }
        .suspect-card {
            display: flex; gap: 15px; align-items: center; background-color: var(--light-bg);
            padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer;
        }
        .suspect-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 50%; flex-shrink: 0; }
        .suspect-card h4 { margin: 0 0 5px 0; font-size: 1.1em; }
        .suspect-card p { margin: 2px 0 0 0; font-size: 0.8em; color: #adb5bd; }
        .suspect-card-info { display: flex; flex-direction: column; }

        /* --- Style Modali (okien dialogowych) --- */
        .modal {
            display: flex; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
            overflow-y: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--dark-bg); padding: 20px;
            width: 90%; max-width: 600px; border-radius: 10px; position: relative; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        .modal-header h2 { margin: 0; flex-grow: 1; }
        .close-button {
            font-size: 20px; font-weight: bold; cursor: pointer; background: #343a40; border: none; color: #aaa;
            border-radius: 50%; width: 32px; height: 32px; display: flex;
            align-items: center; justify-content: center; line-height: 1; flex-shrink: 0;
        }

        .filter-group { margin-bottom: 15px; }
        .filter-group legend { font-weight: bold; margin-bottom: 10px; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-options label { background-color: #343a40; padding: 8px 12px; border-radius: 15px; font-size: 0.9em; cursor: pointer; user-select: none; transition: background-color 0.2s; }
        label.checked { background-color: var(--primary-color); color: white; }
        .filter-options input { display: none; }
        fieldset { border: none; padding: 0; margin: 0; }

        .suspect-details-photos { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .suspect-details-photos img { height: 200px; border-radius: 8px; cursor: pointer; }
        .suspect-details-info, .suspect-stats { display: grid; grid-template-columns: auto 1fr; gap: 5px 15px; margin: 15px 0; }
        .suspect-stats dt, .suspect-details-info dt { font-weight: bold; color: #adb5bd; }
        .event-entry { border-top: 1px solid var(--border-color); padding: 10px 0; }
        .event-header { display: flex; justify-content: space-between; align-items: center; }
        
        .field-selection-menu .btn { margin-bottom: 10px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .modal-tabs .btn { background-color: #343a40; border: 1px solid var(--border-color); flex: 1; }
        .modal-tabs .btn.active { background-color: var(--primary-color); border-color: var(--primary-color); }
        
        /* Style dla modali, które muszą być na wierzchu */
        .fullscreen-photo-modal { z-index: 1003; }
        .fullscreen-photo-modal .modal-content { background: none; padding: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .fullscreen-photo-modal img { max-width: 100%; max-height: 100%; }
        #field-selection-modal { z-index: 1002; }
    </style>
</head>
<body>
    <!-- Główny kontener aplikacji, zarządzany przez Vue.js -->
    <div id="app" :class="{ ready: isReady }">
        <!-- Nagłówek i główne przyciski nawigacyjne -->
        <header>
            <h1>Katalog Sprawców i Zdarzeń</h1>
            <button @click="modals.settings.show = true" class="settings-btn">⚙️</button>
            <nav>
                <button @click="switchView('baza')" :class="{ active: activeView === 'baza' }">Katalog</button>
                <button @click="switchView('dodaj')" :class="{ active: activeView === 'dodaj' }">Dodaj</button>
            </nav>
        </header>
        <main>
            <!-- === WIDOK: KATALOG SPRAWCÓW === -->
            <div v-if="activeView === 'baza'">
                <div class="baza-controls">
                    <input type="search" v-model="searchPhrase" placeholder="Szukaj w sprawcach i zdarzeniach...">
                    <button @click="modals.filters.show = true" class="btn" style="width: auto; flex-shrink: 0;">
                        Filtry <span v-if="activeFilterCount > 0">({{ activeFilterCount }})</span>
                    </button>
                </div>
                <!-- Przyciski pomocnicze, widoczne warunkowo -->
                <button v-if="suspects.length === 0" @click="seedDatabase" class="btn btn-secondary" style="margin-bottom: 20px;">Dodaj rekordy przykładowe</button>
                
                <!-- Lista sprawców generowana dynamicznie przez Vue -->
                <div v-if="filteredSuspects.length > 0">
                    <div v-for="suspect in filteredSuspects" :key="suspect.id" class="suspect-card" @click="showSuspectDetails(suspect.id)">
                        <img :src="suspect.photoUrl" alt="Sprawca">
                        <div class="suspect-card-info">
                            <h4 v-if="suspect.nickname">{{ suspect.nickname }}</h4>
                            <p>{{ getSuspectSummary(suspect) }}</p>
                            <p v-if="suspect.stores.length > 0">Sklepy: {{ suspect.stores.join(', ') }}</p>
                        </div>
                    </div>
                </div>
                <p v-else>Brak wyników spełniających kryteria.</p>
            </div>

            <!-- === WIDOK: DODAJ NOWE ZGŁOSZENIE === -->
            <div v-if="activeView === 'dodaj'">
                <form @submit.prevent="saveNewEntry">
                    <!-- Sekcja dodawania sprawcy -->
                    <div class="form-section">
                        <h3>1. Sprawca (wymagane zdjęcie)</h3>
                        <input type="file" @change="handlePhotoUpload" accept="image/*" multiple required>
                        <div class="photo-preview-container"><img v-for="url in addForm.photoUrls" :src="url" :key="url"></div>
                        <div class="form-group">
                            <!-- Domyślnie widoczne pola -->
                            <div class="form-group-inline">
                                <label>Wiek:</label>
                                <input type="number" v-model.number="addForm.suspect.ageMin" placeholder="Od">
                                <span>-</span>
                                <input type="number" v-model.number="addForm.suspect.ageMax" placeholder="Do">
                            </div>
                            <div v-for="field in addForm.suspectFields" :key="field.key">
                                <div v-if="field.type === 'select'"><select v-model="field.value"><option value="" disabled>{{ field.label }}...</option><option v-for="option in field.options" :value="option">{{ option }}</option></select></div>
                                <input v-if="field.type === 'text'" type="text" v-model="field.value" :placeholder="field.label">
                                <fieldset v-if="field.type === 'checkbox'"><legend>{{ field.label }}</legend><div class="filter-options"><label v-for="option in field.options" :key="option" :class="{checked: field.value.includes(option)}"><span>{{ option }}</span><input type="checkbox" :value="option" v-model="field.value"></label></div></fieldset>
                            </div>
                        </div>
                        <button type="button" class="btn btn-dynamic-add" @click="openFieldSelectionMenu('suspect')">+ Dodaj pole do profilu</button>
                    </div>
                    <!-- Sekcja dodawania zdarzenia (opcjonalna) -->
                    <div class="form-section">
                        <h3>2. Zdarzenie (opcjonalne)</h3>
                        <div class="form-group">
                            <input type="text" v-model="addForm.event.amobitId" placeholder="Numer Amodit (ID Zdarzenia)">
                            <select v-model="addForm.event.type"><option value="" disabled>Rodzaj zdarzenia...</option><option>Udaremnienie</option><option>Ujęcie</option><option>Wykrycie</option></select>
                            <input type="number" v-model="addForm.event.storeNumber" placeholder="Nr sklepu (max 4 cyfry)" max="9999">
                            <input type="date" v-model="addForm.event.date">
                            <!-- Dynamicznie dodawane pola zdarzenia -->
                            <div v-for="field in addForm.eventFields" :key="field.key">
                                <input v-if="field.key === 'amount'" type="number" step="0.01" v-model="field.value" placeholder="Kwota strat">
                                <textarea v-if="field.key === 'description'" v-model="field.value" rows="3" placeholder="Dodatkowy opis..."></textarea>
                                <div v-if="field.key === 'theftType'">
                                    <fieldset><legend>{{ field.label }}</legend><div class="filter-options"><label v-for="option in field.options" :key="option" :class="{checked: field.value.includes(option)}"><span>{{ option }}</span><input type="checkbox" :value="option" v-model="field.value"></label></div></fieldset>
                                    <textarea v-if="field.value.includes('inne')" v-model="addForm.event.theftTypeOther" rows="2" placeholder="Opisz inny typ kradzieży..." style="margin-top: 10px;"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-dynamic-add" @click="openFieldSelectionMenu('event')">+ Dodaj pole do zdarzenia</button>
                    </div>
                    <button type="submit" class="btn btn-success">Zapisz</button>
                </form>
            </div>
        </main>
        
        <!-- === MODALE (okna dialogowe) === -->
        <!-- Modal filtrów -->
        <div v-if="modals.filters.show" class="modal"><div class="modal-content"><div class="modal-header"><h2>Filtry</h2><button @click="modals.filters.show = false" class="close-button">×</button></div><form>
            <fieldset class="filter-group">
                <legend>Zakres wieku</legend>
                <div class="form-group-inline">
                    <input type="number" v-model.number="filters.ageRange.min" placeholder="Od">
                    <span>-</span>
                    <input type="number" v-model.number="filters.ageRange.max" placeholder="Do">
                </div>
            </fieldset>
            <fieldset v-for="(group, key) in filterSchema" :key="key" class="filter-group"><legend>{{ group.label }}</legend><div class="filter-options"><label v-for="option in group.options" :key="option" :class="{checked: filters[key] && filters[key].includes(option)}"><span>{{ option }}</span><input type="checkbox" :value="option" v-model="filters[key]"></label></div></fieldset>
            <fieldset v-if="availableStores.length > 0" class="filter-group"><legend>Numer sklepu</legend><div class="filter-options"><label v-for="store in availableStores" :key="store" :class="{checked: filters.stores.includes(store)}"><span>{{ store }}</span><input type="checkbox" :value="store" v-model="filters.stores"></label></div></fieldset>
        </form><div class="modal-actions"><button @click="modals.filters.show = false" class="btn" style="flex: 2;">Zastosuj</button><button @click="resetFilters" class="btn btn-secondary" style="flex: 1;">Wyczyść</button></div></div></div>
        
        <!-- Modal szczegółów sprawcy -->
        <div v-if="modals.details.show" class="modal"><div class="modal-content">
            <div class="modal-header">
                <h2>{{ modals.details.data.suspect.nickname || 'Sprawca #' + modals.details.data.suspect.id }}</h2>
                <button class="btn-icon" @click="openEditSuspectModal(modals.details.data.suspect)">✏️</button>
                <button @click="modals.details.show = false" class="close-button">×</button>
            </div>
            <div class="suspect-details-photos"><img v-for="url in modals.details.data.suspect.photoUrls" :src="url" @click="showFullscreenPhoto(url)"></div>
            <h3>Dane</h3>
            <dl class="suspect-details-info">
                <dt v-if="modals.details.data.suspect.ageMin || modals.details.data.suspect.ageMax">Wiek</dt>
                <dd v-if="modals.details.data.suspect.ageMin || modals.details.data.suspect.ageMax">{{ modals.details.data.suspect.ageMin || '?' }} - {{ modals.details.data.suspect.ageMax || '?' }} lat</dd>
                <template v-for="(value, key) in modals.details.data.suspect">
                    <template v-if="fieldSchemas.suspect[key] && value && value.length > 0">
                        <dt>{{ fieldSchemas.suspect[key].label }}</dt>
                        <dd>{{ Array.isArray(value) ? value.join(', ') : value }}</dd>
                    </template>
                </template>
            </dl>
            <h3>Statystyki</h3>
            <dl class="suspect-stats">
                <dt>Ostatnie ujęcie</dt><dd>{{ modals.details.data.stats.lastApprehensionDate || 'Nigdy' }}</dd>
                <dt>Suma kradzieży</dt><dd>{{ modals.details.data.stats.totalAmount.toFixed(2) }} zł</dd>
                <dt>Suma od ujęcia</dt><dd>{{ modals.details.data.stats.amountSinceApprehension.toFixed(2) }} zł</dd>
                <dt>Odwiedzone sklepy</dt><dd>{{ modals.details.data.stats.visitedStores.join(', ') || 'Brak' }}</dd>
            </dl>
            <h3>Historia zdarzeń</h3>
            <div v-if="modals.details.data.events.length > 0">
                <div v-for="event in modals.details.data.events" class="event-entry">
                    <div class="event-header">
                        <h5>{{ event.amobitId }}: {{ event.eventType }} - {{ event.eventDate ? new Date(event.eventDate).toLocaleString('pl-PL') : 'Brak daty' }}</h5>
                        <button class="btn-icon" @click="openEditEventModal(event)">✏️</button>
                    </div>
                    <p>Sklep: {{ event.storeNumber || 'nd' }} | Kwota: {{ typeof event.amount === 'number' ? event.amount.toFixed(2) + ' zł' : 'nd' }}</p>
                    <div v-if="event.theftType && event.theftType.length > 0"><p style="margin: 5px 0;"><strong>Typ kradzieży:</strong> {{ event.theftType.filter(t => t !== 'inne').join(', ') }}<span v-if="event.theftType.includes('inne')">, inne: {{ event.theftTypeOther || 'brak opisu' }}</span></p></div>
                    <p style="font-style: italic;">{{ event.description || '' }}</p>
                </div>
            </div>
            <p v-else>Brak zarejestrowanych zdarzeń.</p>
            <div class="modal-actions">
                <button @click="openAddEventModal(modals.details.data.suspect.id)" class="btn" style="flex: 2;">+ Dodaj/Przypisz zdarzenie</button>
                <button @click="deleteSuspect(modals.details.data.suspect.id)" class="btn btn-danger" style="flex: 1;">Usuń</button>
            </div>
        </div></div>

        <!-- Modal wyboru pola do dodania -->
        <div v-if="modals.fields.show" id="field-selection-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Wybierz pole do dodania</h2><button @click="modals.fields.show = false" class="close-button">×</button></div><div class="field-selection-menu"><button v-for="field in modals.fields.available" :key="field.key" @click="addDynamicField(field)" class="btn">{{ field.label }}</button></div></div></div>
        
        <!-- Modal dodawania/przypisywania zdarzenia -->
        <div v-if="modals.addEvent.show" class="modal"><div class="modal-content"><div class="modal-header"><h2>Dodaj zdarzenie do #{{ modals.addEvent.suspectId }}</h2><button @click="modals.addEvent.show = false" class="close-button">×</button></div><div><div class="modal-tabs"><button @click="modals.addEvent.mode = 'new'" :class="{active: modals.addEvent.mode === 'new'}" class="btn">Nowe</button><button @click="modals.addEvent.mode = 'assign'" :class="{active: modals.addEvent.mode === 'assign'}" class="btn">Istniejące</button></div><div v-if="modals.addEvent.mode === 'new'"><form @submit.prevent="saveNewEventToSuspect"><div class="form-group"><input type="text" v-model="addEventForm.amobitId" placeholder="Numer Amodit (ID Zdarzenia)" required><select v-model="addEventForm.type" required><option value="" disabled>Rodzaj zdarzenia...</option><option>Udaremnienie</option><option>Ujęcie</option><option>Wykrycie</option></select><input type="number" v-model="addEventForm.storeNumber" placeholder="Nr sklepu (max 4 cyfry)" max="9999"><input type="date" v-model="addEventForm.date"><div v-for="field in addEventForm.eventFields" :key="field.key"><input v-if="field.key === 'amount'" type="number" step="0.01" v-model="field.value" placeholder="Kwota strat"><textarea v-if="field.key === 'description'" v-model="field.value" rows="3" placeholder="Dodatkowy opis..."></textarea><div v-if="field.key === 'theftType'"><fieldset><legend>{{ field.label }}</legend><div class="filter-options"><label v-for="option in field.options" :key="option" :class="{checked: field.value.includes(option)}"><span>{{ option }}</span><input type="checkbox" :value="option" v-model="field.value"></label></div></fieldset><textarea v-if="field.value.includes('inne')" v-model="addEventForm.theftTypeOther" rows="2" placeholder="Opisz inny typ kradzieży..." style="margin-top: 10px;"></textarea></div></div></div><button type="button" class="btn btn-dynamic-add" @click="openFieldSelectionMenu('event', true)">+ Dodaj pole</button><button type="submit" class="btn btn-success" style="margin-top: 15px;">Zapisz nowe zdarzenie</button></form></div><div v-if="modals.addEvent.mode === 'assign'"><form @submit.prevent="assignExistingEvent"><input type="text" v-model="assignEventId" placeholder="Wpisz numer Amodit zdarzenia" required><button type="submit" class="btn btn-success" style="margin-top: 15px;">Przypisz zdarzenie</button></form></div></div></div></div>
        
        <!-- Modal edycji sprawcy -->
        <div v-if="modals.editSuspect.show" class="modal"><div class="modal-content">
            <div class="modal-header"><h2>Edytuj sprawcę</h2><button @click="modals.editSuspect.show = false" class="close-button">×</button></div>
            <form @submit.prevent="saveSuspectChanges">
                <div class="form-group">
                    <!-- Sekcja edycji zdjęć -->
                    <label>Zdjęcia</label>
                    <div class="photo-preview-container">
                        <div v-for="(url, index) in modals.editSuspect.photoUrls" :key="url" class="photo-edit-wrapper">
                            <img :src="url">
                            <div @click="removePhotoFromEdit(index)" class="photo-delete-btn">×</div>
                        </div>
                    </div>
                    <label for="edit-photos-input" class="btn btn-secondary" style="margin-top: 10px;">+ Dodaj nowe zdjęcia</label>
                    <input type="file" id="edit-photos-input" @change="addPhotosToEdit" accept="image/*" multiple style="display: none;">
                    
                    <!-- Sekcja edycji danych -->
                    <div class="form-group-inline"><label>Wiek:</label><input type="number" v-model.number="modals.editSuspect.data.ageMin" placeholder="Od"><input type="number" v-model.number="modals.editSuspect.data.ageMax" placeholder="Do"></div>
                    <div v-for="field in modals.editSuspect.fields" :key="field.key">
                        <label>{{field.label}}</label>
                        <div v-if="field.type === 'select'"><select v-model="field.value"><option value="" disabled>Wybierz...</option><option v-for="option in field.options" :value="option">{{ option }}</option></select></div>
                        <input v-if="field.type === 'text'" type="text" v-model="field.value" :placeholder="field.label">
                        <fieldset v-if="field.type === 'checkbox'"><div class="filter-options"><label v-for="option in field.options" :key="option" :class="{checked: field.value.includes(option)}"><span>{{ option }}</span><input type="checkbox" :value="option" v-model="field.value"></label></div></fieldset>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Zapisz zmiany</button>
            </form>
        </div></div>

        <!-- Modal edycji zdarzenia -->
        <div v-if="modals.editEvent.show" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edytuj zdarzenie {{ modals.editEvent.data.amobitId }}</h2><button @click="modals.editEvent.show = false" class="close-button">×</button></div><form @submit.prevent="saveEventChanges"><div class="form-group"><label>Rodzaj zdarzenia</label><select v-model="modals.editEvent.data.eventType"><option>Udaremnienie</option><option>Ujęcie</option><option>Wykrycie</option></select><label>Nr sklepu</label><input type="number" v-model="modals.editEvent.data.storeNumber"><label>Data</label><input type="date" v-model="modals.editEvent.data.dateForInput"><label>Typ kradzieży</label><fieldset><div class="filter-options"><label v-for="option in fieldSchemas.event.theftType.options" :key="option" :class="{checked: modals.editEvent.data.theftType && modals.editEvent.data.theftType.includes(option)}"><span>{{ option }}</span><input type="checkbox" :value="option" v-model="modals.editEvent.data.theftType"></label></div></fieldset><textarea v-if="modals.editEvent.data.theftType && modals.editEvent.data.theftType.includes('inne')" v-model="modals.editEvent.data.theftTypeOther" rows="2" placeholder="Opisz inny typ kradzieży..."></textarea><label>Kwota</label><input type="number" step="0.01" v-model="modals.editEvent.data.amount"><label>Opis</label><textarea v-model="modals.editEvent.data.description"></textarea></div><button type="submit" class="btn btn-success">Zapisz zmiany</button></form></div></div>
        
        <!-- Modal ustawień -->
        <div v-if="modals.settings.show" class="modal"><div class="modal-content">
            <div class="modal-header"><h2>Ustawienia</h2><button @click="modals.settings.show = false" class="close-button">×</button></div>
            <p>Twórca: Radosław Kamiński<br>radoslaw.kaminski.mail@gmail.com</p>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <h3>Zarządzanie danymi</h3>
            <div class="form-group">
                <button @click="exportDatabase" class="btn btn-secondary">Eksportuj dane do pliku</button>
                
                <fieldset style="border: 1px solid var(--border-color); padding: 15px; border-radius: 8px;">
                    <legend style="padding: 0 10px;">Import z pliku</legend>
                    <div class="form-group">
                        <label for="import-merge" class="btn btn-secondary">Połącz (dodaj brakujące)</label>
                        <input type="file" id="import-merge" @change="importDatabase($event, 'merge')" accept=".json" style="display: none;">

                        <label for="import-add" class="btn btn-secondary">Dodaj wszystko jako nowe</label>
                        <input type="file" id="import-add" @change="importDatabase($event, 'addAll')" accept=".json" style="display: none;">

                        <label for="import-replace" class="btn btn-danger">Zastąp (wymaż i wgraj)</label>
                        <input type="file" id="import-replace" @change="importDatabase($event, 'replace')" accept=".json" style="display: none;">
                    </div>
                </fieldset>
            </div>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <button v-if="suspects.length > 0" @click="clearDatabase" class="btn btn-danger">Wyczyść całą bazę</button>
        </div></div>
        
        <!-- Modal pełnoekranowego zdjęcia -->
        <div v-if="modals.fullscreenPhoto.show" class="modal fullscreen-photo-modal" @click="modals.fullscreenPhoto.show = false"><div class="modal-content"><img :src="modals.fullscreenPhoto.url"></div></div>
    </div>

    <script>
    // === BAZA DANYCH (DEXIE.JS) ===
    const db = new Dexie('AmobitSecurityVueDB');
    // Wersja 3: Zmiana pola 'age' na 'ageMin' i 'ageMax'
    db.version(3).stores({
        suspects: '++id, nickname, gender, ageMin, ageMax, hairColor, hairLength, glasses, zarost, *tattoos',
        events: '&amobitId, suspectId, *theftType',
    }).upgrade(tx => {
        // Skrypt migracji z wersji 2 do 3
        return tx.table('suspects').toCollection().modify(s => {
            if (s.age) { // Jeśli istnieje stare pole 'age'
                const ageMap = {
                    "Poniżej 18": { min: null, max: 17 }, "18-25": { min: 18, max: 25 },
                    "26-40": { min: 26, max: 40 }, "41-60": { min: 41, max: 60 },
                    "Powyżej 60": { min: 61, max: null }
                };
                const range = ageMap[s.age];
                if (range) {
                    s.ageMin = range.min;
                    s.ageMax = range.max;
                }
                delete s.age; // Usuń stare pole
            }
        });
    });
    db.version(2).stores({
        suspects: '++id, nickname, gender, age, hairColor, hairLength, glasses, zarost, *tattoos',
        events: '&amobitId, suspectId, *theftType',
    }).upgrade(tx => {
        return tx.table("events").toCollection().modify(event => {
            if (event.theftType === undefined) event.theftType = [];
            if (event.theftTypeOther === undefined) event.theftTypeOther = '';
        });
    });

    // === SCHEMATY PÓL ===
    const fieldSchemas = {
        suspect: {
            nickname: { label: "Pseudonim", type: "text" },
            gender: { label: "Płeć", type: "select", options: ["Kobieta", "Mężczyzna", "Inne"] },
            hairColor: { label: "Kolor włosów", type: "select", options: ["Blond", "Brunet", "Czarne", "Rude", "Siwe", "Inny"] },
            hairLength: { label: "Długość włosów", type: "select", options: ["Krótkie", "Do ramion", "Długie", "Łysy"] },
            glasses: { label: "Okulary", type: "select", options: ["Tak", "Nie", "Nieraz"] },
            zarost: { label: "Zarost", type: "select", options: ["Brak", "Wąsy", "Broda", "Kozia bródka", "Kilkudniowy zarost"] },
            tattoos: { label: "Tatuaże", type: "checkbox", options: ["Prawa dłoń", "Lewa dłoń", "Prawe ramię", "Lewe ramię", "Szyja", "Nogi", "Twarz"] },
        },
        event: {
            amount: { label: "Kwota kradzieży", type: "number" },
            description: { label: "Opis", type: "textarea" },
            theftType: { label: "Typ kradzieży", type: "checkbox", options: ["biegacz (szczotki)", "perfumy maszynki itp", "KSO", "kolorówka", "wyjmuje z pudełek", "co popadnie, co w rączki wpadnie na sali", "inne"] },
        }
    };

    // === FUNKCJE POMOCNICZE DO IMPORTU/EKSPORTU ===
    const blobToBase64 = blob => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    const base64ToBlob = (base64, type = 'application/octet-stream') => {
        const byteCharacters = atob(base64.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type });
    }

    // === GŁÓWNA INSTANCJA VUE.JS ===
    new Vue({
        el: '#app',
        data: {
            isReady: false,
            activeView: 'baza',
            suspects: [],
            availableStores: [],
            searchPhrase: '',
            modals: {
                filters: { show: false },
                details: { show: false, data: { suspect: {}, events: [], stats: {} } },
                fields: { show: false, target: null, available: [] },
                addEvent: { show: false, suspectId: null, mode: 'new' },
                editSuspect: { show: false, data: {}, fields: [], photoUrls: [] },
                editEvent: { show: false, data: {} },
                settings: { show: false },
                fullscreenPhoto: { show: false, url: '' }
            },
            filters: {},
            addForm: {},
            addEventForm: {},
            assignEventId: '',
            fieldSchemas: fieldSchemas,
        },
        computed: {
            filterSchema() {
                const schema = {};
                for (const key in fieldSchemas.suspect) {
                    if (key !== 'nickname' && key !== 'age') {
                        const originalOptions = fieldSchemas.suspect[key].options;
                        schema[key] = {
                            label: fieldSchemas.suspect[key].label,
                            options: [...originalOptions, "Nieokreślone"]
                        };
                    }
                }
                return schema;
            },
            filteredSuspects() {
                if (!this.isReady) return [];
                const phrase = this.searchPhrase.toLowerCase().trim();
                const defaultAgeFilter = { min: 10, max: 90 };
                
                return this.suspects.filter(suspect => {
                    // Filtr wieku (zakresy muszą się pokrywać)
                    const filterRange = this.filters.ageRange;
                    if (filterRange.min > defaultAgeFilter.min || filterRange.max < defaultAgeFilter.max) {
                        if (!suspect.ageMin && !suspect.ageMax) return false; // Wyklucz, jeśli sprawca nie ma zdefiniowanego wieku
                        // Logika pokrywania się zakresów: !(koniec_A < początek_B || początek_A > koniec_B)
                        const overlaps = (suspect.ageMin || 0) <= filterRange.max && (suspect.ageMax || 999) >= filterRange.min;
                        if (!overlaps) return false;
                    }

                    // Filtry cech
                    for (const key in this.filters) {
                        if (key === 'ageRange' || key === 'stores') continue;
                        const requiredValues = this.filters[key];
                        if (!requiredValues || requiredValues.length === 0) continue;
                        
                        const suspectValue = suspect[key];
                        const isUnspecified = suspectValue == null || suspectValue === '' || (Array.isArray(suspectValue) && suspectValue.length === 0);
                        
                        const match = requiredValues.some(required => {
                            if (required === 'Nieokreślone') return isUnspecified;
                            if (isUnspecified) return false;
                            if (Array.isArray(suspectValue)) return suspectValue.includes(required);
                            return suspectValue === required;
                        });
                        if (!match) return false;
                    }

                    // Filtr sklepów
                    if (this.filters.stores && this.filters.stores.length > 0) {
                        if (!this.filters.stores.some(store => suspect.stores.includes(store))) {
                            return false;
                        }
                    }
                    
                    // Wyszukiwanie frazą
                    if (phrase) {
                        if (!suspect.searchableText.includes(phrase)) return false;
                    }

                    return true;
                });
            },
            activeFilterCount() {
                let count = 0;
                const defaultAgeFilter = { min: 10, max: 90 };
                for (const key in this.filters) {
                    if (key === 'ageRange') {
                        if (this.filters.ageRange.min !== defaultAgeFilter.min || this.filters.ageRange.max !== defaultAgeFilter.max) {
                            count++;
                        }
                    } else if (this.filters[key] && this.filters[key].length > 0) {
                        count += this.filters[key].length;
                    }
                }
                return count;
            }
        },
        methods: {
            getSuspectSummary(suspect) {
                let parts = [];
                if (suspect.gender) parts.push(suspect.gender);
                if (suspect.ageMin || suspect.ageMax) parts.push(`${suspect.ageMin || '?'}-${suspect.ageMax || '?'} lat`);
                if (suspect.hairColor) parts.push(suspect.hairColor);
                return parts.filter(Boolean).join(', ');
            },
            switchView(viewName) { this.activeView = viewName; if (viewName === 'dodaj') this.resetAddForm(); },
            resetAddForm() {
                // Pola widoczne domyślnie
                const defaultFields = ['gender', 'hairColor'].map(key => {
                    const schema = fieldSchemas.suspect[key];
                    return { key, ...schema, value: '' };
                });

                this.addForm = {
                    photos: [], photoUrls: [], 
                    suspectFields: defaultFields, 
                    eventFields: [],
                    suspect: { ageMin: null, ageMax: null },
                    event: { amobitId: '', type: '', storeNumber: '', date: new Date().toISOString().slice(0, 10), theftTypeOther: '' },
                };
            },
            resetAddEventForm() { this.addEventForm = { amobitId: '', type: '', storeNumber: '', date: new Date().toISOString().slice(0, 10), eventFields: [], theftTypeOther: '' }; },
            handlePhotoUpload(e) {
                this.addForm.photos = Array.from(e.target.files);
                this.addForm.photoUrls = this.addForm.photos.map(p => URL.createObjectURL(p));
            },
            openFieldSelectionMenu(target, forAddEventModal = false) {
                const form = forAddEventModal ? this.addEventForm : this.addForm;
                const existing = forAddEventModal ? form.eventFields.map(f => f.key) : (target === 'suspect' ? form.suspectFields.map(f => f.key) : form.eventFields.map(f => f.key));
                const schema = fieldSchemas[target];
                this.modals.fields.available = Object.keys(schema)
                    .filter(key => !existing.includes(key))
                    .map(key => ({ key, label: schema[key].label, target, forAddEventModal }));
                this.modals.fields.target = target;
                this.modals.fields.show = true;
            },
            addDynamicField(field) {
                const { target, key, forAddEventModal } = field;
                const schema = fieldSchemas[target][key];
                const newField = {
                    key: key, label: schema.label, type: schema.type,
                    options: schema.options, value: schema.type === 'checkbox' ? [] : '',
                };
                const form = forAddEventModal ? this.addEventForm : this.addForm;
                if (target === 'suspect') form.suspectFields.push(newField);
                else form.eventFields.push(newField);
                this.modals.fields.show = false;
            },
            async saveNewEntry() {
                if (this.addForm.photos.length === 0) return alert('Musisz dodać przynajmniej jedno zdjęcie sprawcy.');
                
                const suspectData = { 
                    photos: this.addForm.photos,
                    ageMin: this.addForm.suspect.ageMin,
                    ageMax: this.addForm.suspect.ageMax
                };
                this.addForm.suspectFields.forEach(f => suspectData[f.key] = f.value);
                
                try {
                    const suspectId = await db.suspects.add(suspectData);
                    
                    if (this.addForm.event.amobitId) {
                        const eventData = {
                            amobitId: this.addForm.event.amobitId, eventType: this.addForm.event.type || 'Wykrycie',
                            storeNumber: this.addForm.event.storeNumber,
                            eventDate: this.addForm.event.date ? new Date(this.addForm.event.date).toISOString() : null,
                            suspectId: suspectId
                        };
                        this.addForm.eventFields.forEach(f => {
                            if(f.key === 'amount') eventData.amount = parseFloat(f.value) || 0;
                            else if (f.key === 'theftType') eventData.theftType = f.value;
                            else eventData[f.key] = f.value;
                        });
                        if (eventData.theftType && eventData.theftType.includes('inne')) {
                            eventData.theftTypeOther = this.addForm.event.theftTypeOther;
                        }
                         await db.events.add(eventData);
                    }
                    alert('Pomyślnie dodano nowego sprawcę.');
                    this.switchView('baza');
                    this.loadSuspects();
                } catch (error) {
                    if (error.name === 'ConstraintError') alert('Błąd: Numer Amodit musi być unikalny!');
                    else alert('Wystąpił błąd podczas zapisu.');
                    console.error('Błąd zapisu:', error);
                }
            },
            async loadSuspects() {
                const allSuspects = await db.suspects.toArray();
                const allEvents = await db.events.toArray();
                
                this.availableStores = [...new Set(allEvents.map(e => e.storeNumber).filter(Boolean))].sort((a, b) => a - b);
                
                this.suspects = allSuspects.map(s => {
                    const relatedEvents = allEvents.filter(e => e.suspectId === s.id);
                    const stores = [...new Set(relatedEvents.map(e => e.storeNumber).filter(Boolean))];
                    const searchableText = (JSON.stringify(s) + JSON.stringify(relatedEvents)).toLowerCase();

                    return { 
                        ...s, 
                        photoUrl: s.photos && s.photos.length > 0 ? URL.createObjectURL(s.photos[0]) : '', 
                        stores,
                        searchableText 
                    };
                });
            },
            async showSuspectDetails(suspectId) {
                const suspect = await db.suspects.get(suspectId);
                const events = await db.events.where({ suspectId }).sortBy('eventDate');
                events.reverse();

                const lastApprehension = events.find(e => e.eventType === 'Ujęcie');
                const totalAmount = events.reduce((sum, e) => sum + (e.amount || 0), 0);
                let amountSinceApprehension = totalAmount;
                if(lastApprehension) {
                    amountSinceApprehension = events.filter(e => !e.eventDate || !lastApprehension.eventDate || new Date(e.eventDate) > new Date(lastApprehension.eventDate)).reduce((sum, e) => sum + (e.amount || 0), 0);
                }
                const visitedStores = [...new Set(events.map(e => e.storeNumber).filter(Boolean))];

                this.modals.details.data = {
                    suspect: { ...suspect, photoUrls: suspect.photos.map(p => URL.createObjectURL(p)) },
                    events,
                    stats: { lastApprehensionDate: lastApprehension ? new Date(lastApprehension.eventDate).toLocaleDateString('pl-PL') : null, totalAmount, amountSinceApprehension, visitedStores }
                };
                this.modals.details.show = true;
            },
            openEditSuspectModal(suspect) {
                this.modals.editSuspect.data = JSON.parse(JSON.stringify(suspect));
                this.modals.editSuspect.photoUrls = suspect.photos.map(p => URL.createObjectURL(p));
                this.modals.editSuspect.fields = Object.keys(fieldSchemas.suspect).map(key => {
                    const schema = fieldSchemas.suspect[key];
                    return { key, ...schema, value: suspect[key] || (schema.type === 'checkbox' ? [] : '') }
                });
                this.modals.details.show = false;
                this.modals.editSuspect.show = true;
            },
            async saveSuspectChanges() {
                const suspectData = this.modals.editSuspect.data;
                const updatedData = {
                    ageMin: suspectData.ageMin,
                    ageMax: suspectData.ageMax,
                    photos: suspectData.photos // Zapisz zaktualizowaną tablicę zdjęć (Blobów)
                };
                this.modals.editSuspect.fields.forEach(f => updatedData[f.key] = f.value);
                
                await db.suspects.update(suspectData.id, updatedData);
                alert('Dane sprawcy zaktualizowane.');
                this.modals.editSuspect.show = false;
                this.loadSuspects();
            },
            addPhotosToEdit(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    this.modals.editSuspect.data.photos.push(file);
                    this.modals.editSuspect.photoUrls.push(URL.createObjectURL(file));
                });
                event.target.value = ''; // Resetuj input, aby można było dodać ten sam plik ponownie
            },
            removePhotoFromEdit(index) {
                // Usuń zarówno Blob, jak i jego URL
                this.modals.editSuspect.data.photos.splice(index, 1);
                this.modals.editSuspect.photoUrls.splice(index, 1);
            },
            openEditEventModal(event) {
                this.modals.editEvent.data = JSON.parse(JSON.stringify(event));
                if (!this.modals.editEvent.data.theftType) this.$set(this.modals.editEvent.data, 'theftType', []);
                if (this.modals.editEvent.data.eventDate) {
                    this.modals.editEvent.data.dateForInput = new Date(this.modals.editEvent.data.eventDate).toISOString().slice(0, 10);
                }
                this.modals.details.show = false;
                this.modals.editEvent.show = true;
            },
            async saveEventChanges() {
                const eventData = this.modals.editEvent.data;
                const updates = {
                    eventType: eventData.eventType, storeNumber: eventData.storeNumber,
                    eventDate: eventData.dateForInput ? new Date(eventData.dateForInput).toISOString() : null,
                    amount: parseFloat(eventData.amount) || 0, description: eventData.description,
                    theftType: eventData.theftType || [], theftTypeOther: eventData.theftTypeOther || ''
                };
                await db.events.update(eventData.amobitId, updates);
                alert('Zdarzenie zaktualizowane.');
                this.modals.editEvent.show = false;
                this.loadSuspects();
            },
            resetFilters() {
                this.initializeFilters(); // Używa funkcji inicjalizującej do resetowania
                this.modals.filters.show = false;
            },
            initializeFilters() {
                const filterKeys = Object.keys(fieldSchemas.suspect).filter(k => k !== 'nickname');
                const filters = {};
                filterKeys.forEach(key => filters[key] = []);
                filters.stores = [];
                filters.ageRange = { min: 10, max: 90 }; // Domyślny, szeroki zakres
                this.filters = filters;
            },
            async seedDatabase() {
                if (!confirm("Czy na pewno chcesz dodać przykładowe dane? Usunie to wszystkie istniejące rekordy.")) return;
                await this.clearDatabase(false);

                const sampleData = [
                    { suspect: { nickname: 'Broderia z Thotem', gender: 'Kobieta', ageMin: 28, ageMax: 35, hairColor: 'Blond', hairLength: 'Długie', zarost: 'Brak' }, event: { amobitId: 'AMOBIT-001', eventType: 'Udaremnienie', storeNumber: '123', amount: 150.50, theftType: ['perfumy maszynki itp'] } },
                    { suspect: { nickname: 'Szybki Lopez', gender: 'Mężczyzna', ageMin: 20, ageMax: 24, hairColor: 'Czarne', hairLength: 'Krótkie', tattoos: ['Prawe ramię'], zarost: 'Kilkudniowy zarost' }, event: { amobitId: 'AMOBIT-002', eventType: 'Ujęcie', storeNumber: '456', amount: 320.00, theftType: ['biegacz (szczotki)', 'inne'], theftTypeOther: 'Ukradł też drogie alkohole' } },
                    { suspect: { gender: 'Mężczyzna', ageMin: 50, ageMax: 60, hairColor: '', hairLength: 'Łysy', glasses: 'Tak' }, event: { amobitId: 'AMOBIT-003', eventType: 'Wykrycie', storeNumber: '123', description: 'Stały klient.' } },
                ];
                
                const canvas = document.createElement('canvas'); canvas.width = 100; canvas.height = 100;
                const ctx = canvas.getContext('2d'); ctx.fillStyle = '#ccc'; ctx.fillRect(0, 0, 100, 100);
                const placeholderBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

                for (const entry of sampleData) {
                    entry.suspect.photos = [placeholderBlob];
                    const suspectId = await db.suspects.add(entry.suspect);
                    entry.event.suspectId = suspectId;
                    entry.event.eventDate = new Date(Date.now() - Math.random() * 1e10).toISOString();
                    await db.events.add(entry.event);
                }
                alert('Dodano dane przykładowe.');
                this.loadSuspects();
            },
            async clearDatabase(confirmFirst = true) {
                if (confirmFirst && !confirm("Czy na pewno chcesz usunąć WSZYSTKIE dane z bazy? Tej operacji nie można cofnąć.")) return;
                await db.delete();
                await db.open();
                if (confirmFirst) alert('Baza danych została wyczyszczona.');
                this.modals.settings.show = false;
                this.loadSuspects();
            },
            openAddEventModal(suspectId) {
                this.resetAddEventForm();
                this.modals.addEvent.suspectId = suspectId;
                this.modals.addEvent.show = true;
            },
            async saveNewEventToSuspect() {
                const form = this.addEventForm;
                if (!form.amobitId) return alert('Musisz podać numer Amodit.');

                const eventData = {
                    amobitId: form.amobitId, eventType: form.type,
                    storeNumber: form.storeNumber, eventDate: form.date ? new Date(form.date).toISOString() : null,
                    suspectId: this.modals.addEvent.suspectId
                };
                form.eventFields.forEach(f => {
                    if (f.key === 'amount') eventData.amount = parseFloat(f.value) || 0;
                    else if (f.key === 'theftType') eventData.theftType = f.value;
                    else eventData[f.key] = f.value;
                });
                if (eventData.theftType && eventData.theftType.includes('inne')) {
                    eventData.theftTypeOther = form.theftTypeOther;
                }

                try {
                    await db.events.add(eventData);
                    alert('Dodano nowe zdarzenie.');
                    this.modals.addEvent.show = false;
                    this.showSuspectDetails(this.modals.addEvent.suspectId);
                } catch (error) {
                    if (error.name === 'ConstraintError') alert('Błąd: Numer Amodit musi być unikalny!');
                    else alert('Wystąpił błąd podczas zapisu.');
                }
            },
            async assignExistingEvent() {
                const amobitId = this.assignEventId;
                if (!amobitId) return alert('Wpisz numer Amodit.');

                const event = await db.events.get(amobitId);
                if (!event) return alert('Nie znaleziono zdarzenia o podanym numerze Amodit.');

                await db.events.update(amobitId, { suspectId: this.modals.addEvent.suspectId });
                alert(`Zdarzenie ${amobitId} zostało przypisane.`);
                this.assignEventId = '';
                this.modals.addEvent.show = false;
                this.showSuspectDetails(this.modals.addEvent.suspectId);
            },
            async deleteSuspect(suspectId) {
                if (!confirm(`Czy na pewno chcesz usunąć sprawcę #${suspectId} i wszystkie jego zdarzenia? Tej operacji nie można cofnąć.`)) return;

                try {
                    await db.transaction('rw', db.suspects, db.events, async () => {
                        await db.events.where({ suspectId }).delete();
                        await db.suspects.delete(suspectId);
                    });
                    alert(`Sprawca #${suspectId} został usunięty.`);
                    this.modals.details.show = false;
                    this.loadSuspects();
                } catch (error) {
                    alert('Wystąpił błąd podczas usuwania.');
                    console.error('Błąd usuwania:', error);
                }
            },
            showFullscreenPhoto(url) {
                this.modals.fullscreenPhoto.url = url;
                this.modals.fullscreenPhoto.show = true;
            },
            async exportDatabase() {
                try {
                    const allSuspects = await db.suspects.toArray();
                    const allEvents = await db.events.toArray();

                    const serializableSuspects = await Promise.all(allSuspects.map(async s => {
                        const photosAsBase64 = await Promise.all((s.photos || []).map(p => blobToBase64(p)));
                        // Dołączamy oryginalne ID do eksportu, aby zachować relacje
                        return { ...s, id: s.id, photos: photosAsBase64 };
                    }));

                    const dataToExport = {
                        suspects: serializableSuspects,
                        events: allEvents
                    };

                    const jsonString = JSON.stringify(dataToExport, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const filename = `katalog-sprawcow-backup-${timestamp}.json`;

                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);

                    alert('Eksport danych zakończony pomyślnie.');
                } catch (error) {
                    console.error('Błąd podczas eksportu:', error);
                    alert('Wystąpił błąd podczas eksportu danych.');
                }
            },
            async importDatabase(event, mode) {
                const file = event.target.files[0];
                if (!file) return;

                const confirmMessages = {
                    replace: "Import ZASTĄPI całą obecną bazę. Czy na pewno chcesz kontynuować?",
                    merge: "Import POŁĄCZY dane. Zostaną dodane tylko brakujące zdarzenia i powiązani z nimi sprawcy. Kontynuować?",
                    addAll: "Import DODA wszystkie dane z pliku jako nowe wpisy (oprócz zdarzeń o tym samym ID). Kontynuować?"
                };

                if (!confirm(confirmMessages[mode])) {
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.suspects || !importedData.events) throw new Error("Plik importu ma nieprawidłową strukturę.");

                        // Konwertuj zdjęcia z Base64 na Blob
                        const suspectsWithBlobs = importedData.suspects.map(s => {
                            const photosAsBlobs = (s.photos || []).map(base64String => {
                                const mimeType = base64String.match(/:(.*?);/)[1];
                                return base64ToBlob(base64String, mimeType);
                            });
                            return { ...s, photos: photosAsBlobs };
                        });

                        await db.transaction('rw', db.suspects, db.events, async () => {
                            const oldIdToNewIdMap = new Map();
                            
                            if (mode === 'replace') {
                                await db.suspects.clear();
                                await db.events.clear();
                            }

                            let suspectsToAdd = [];
                            let eventsToAdd = [];

                            if (mode === 'replace' || mode === 'addAll') {
                                suspectsToAdd = suspectsWithBlobs;
                                const existingAmobitIds = new Set(await db.events.toCollection().keys());
                                eventsToAdd = importedData.events.filter(ev => !existingAmobitIds.has(ev.amobitId));
                            } else if (mode === 'merge') {
                                const existingAmobitIds = new Set(await db.events.toCollection().keys());
                                eventsToAdd = importedData.events.filter(ev => !existingAmobitIds.has(ev.amobitId));
                                
                                const requiredSuspectIds = new Set(eventsToAdd.map(ev => ev.suspectId));
                                const existingSuspectIds = new Set(await db.suspects.toCollection().keys());
                                
                                // W trybie merge, dodajemy tylko tych sprawców, którzy są potrzebni dla nowych zdarzeń
                                // i których ID nie koliduje z istniejącymi (chociaż Dexie i tak nada nowe ID)
                                suspectsToAdd = suspectsWithBlobs.filter(s => requiredSuspectIds.has(s.id));
                            }
                            
                            if (suspectsToAdd.length === 0 && eventsToAdd.length === 0) {
                                alert("Brak nowych danych do zaimportowania.");
                                return;
                            }

                            // Dodaj sprawców i zmapuj ich stare ID na nowe
                            for (const suspect of suspectsToAdd) {
                                const originalId = suspect.id;
                                delete suspect.id; // Pozwól Dexie nadać nowe ID
                                const newId = await db.suspects.add(suspect);
                                oldIdToNewIdMap.set(originalId, newId);
                            }

                            // Zaktualizuj 'suspectId' w zdarzeniach i dodaj je
                            const remappedEvents = eventsToAdd.map(event => {
                                const newSuspectId = oldIdToNewIdMap.get(event.suspectId);
                                if (newSuspectId) { // Dodaj tylko jeśli sprawca został zaimportowany
                                    return { ...event, suspectId: newSuspectId };
                                }
                                return null;
                            }).filter(Boolean); // Usuń nulle

                            if (remappedEvents.length > 0) {
                                await db.events.bulkAdd(remappedEvents);
                            }
                            
                            alert(`Import zakończony pomyślnie. Dodano ${oldIdToNewIdMap.size} sprawców i ${remappedEvents.length} zdarzeń.`);
                        });

                        this.modals.settings.show = false;
                        await this.loadSuspects();
                    } catch (error) {
                        console.error("Błąd importu:", error);
                        alert(`Wystąpił błąd podczas importu: ${error.message}`);
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            },
        },
        async mounted() {
            this.initializeFilters();
            await this.loadSuspects();
            this.resetAddForm();
            this.resetAddEventForm();
            this.isReady = true;
        }
    });
    </script>
    
    <!-- PWA / Instalacja -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('ServiceWorker zarejestrowany pomyślnie:', registration.scope);
          }, err => {
            console.log('Rejestracja ServiceWorkera nie powiodła się:', err);
          });
        });
      }
    </script>
</body>
</html>
